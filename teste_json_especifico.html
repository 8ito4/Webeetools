<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste JSON Específico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .panel {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
        }
        .title {
            color: #4CAF50;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .input-area, .output-area {
            background: #333;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            min-height: 300px;
            border: 1px solid #555;
            overflow: auto;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #1976D2;
        }
        .btn-success {
            background: #4CAF50;
        }
        .btn-success:hover {
            background: #45a049;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }
        .status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }
    </style>
</head>
<body>
    <h1>🧪 Teste JSON Específico - Problema da Imagem</h1>
    
    <div class="container">
        <div class="panel">
            <div class="title">JSON de Entrada (Problemático)</div>
            <div class="input-area" id="input">{"idade":30,"email":"maria@example.com","ativo":true,"interesses":"leitura","endereco":"rua \"Rua das Flores","numero":"200","cidade":"Belo Horizonte","estado":"MG","cep":"30123-456"}</div>
        </div>
        
        <div class="panel">
            <div class="title">JSON Formatado (Resultado)</div>
            <div class="output-area" id="output"></div>
        </div>
    </div>
    
    <div style="text-align: center;">
        <button class="btn btn-success" onclick="testFormatting()">🔧 Testar Formatação</button>
        <button class="btn" onclick="testCorrection()">✨ Testar Correção</button>
        <button class="btn" onclick="clearAll()">🧹 Limpar</button>
    </div>
    
    <div id="status"></div>
    
    <div style="margin-top: 30px; padding: 20px; background: #333; border-radius: 8px;">
        <h3>📋 Outros Exemplos Problemáticos</h3>
        <button class="btn" onclick="loadExample(1)">Exemplo 1: Aspas Malformadas</button>
        <button class="btn" onclick="loadExample(2)">Exemplo 2: Vírgulas Extras</button>
        <button class="btn" onclick="loadExample(3)">Exemplo 3: Estrutura Complexa</button>
        <button class="btn" onclick="loadExample(4)">Exemplo 4: Arrays Malformados</button>
    </div>

    <script>
        // Implementação das funções melhoradas
        function processAllScenarios(input) {
            console.log('🔄 Processando todos os cenários possíveis...');
            
            // Cenário 1: JSON já válido
            try {
                const parsed = JSON.parse(input);
                const formatted = JSON.stringify(parsed, null, 4);
                console.log('✅ Cenário 1: JSON válido detectado');
                return { success: true, formatted, wasCorrected: false };
            } catch (e) {
                console.log('❌ Cenário 1 falhou, tentando correção...');
            }
            
            // Cenário 2: JSON com pequenos erros (aspas, vírgulas)
            try {
                const corrected = basicJSONFix(input);
                const parsed = JSON.parse(corrected);
                const formatted = JSON.stringify(parsed, null, 4);
                console.log('✅ Cenário 2: JSON corrigido com correções básicas');
                return { success: true, formatted, corrected, wasCorrected: true };
            } catch (e) {
                console.log('❌ Cenário 2 falhou, tentando extração...');
            }
            
            // Cenário 3: Dados estruturados malformados
            try {
                const extracted = extractStructuredData(input);
                if (extracted && Object.keys(extracted).length > 0) {
                    const formatted = JSON.stringify(extracted, null, 4);
                    console.log('✅ Cenário 3: Dados extraídos com sucesso');
                    return { success: true, formatted, corrected: JSON.stringify(extracted), wasCorrected: true };
                }
            } catch (e) {
                console.log('❌ Cenário 3 falhou, tentando texto simples...');
            }
            
            // Cenário 4: Texto simples com pares chave-valor
            try {
                const simple = extractSimpleKeyValue(input);
                if (simple && Object.keys(simple).length > 0) {
                    const formatted = JSON.stringify(simple, null, 4);
                    console.log('✅ Cenário 4: Pares chave-valor extraídos');
                    return { success: true, formatted, corrected: JSON.stringify(simple), wasCorrected: true };
                }
            } catch (e) {
                console.log('❌ Cenário 4 falhou');
            }
            
            console.log('❌ Todos os cenários falharam');
            return { success: false };
        }

        function basicJSONFix(input) {
            let fixed = input;
            
            console.log('🔧 Aplicando correções básicas...');
            console.log('Input original:', input);
            
            // Remove comentários
            fixed = fixed.replace(/\/\*[\s\S]*?\*\//g, '');
            fixed = fixed.replace(/\/\/.*$/gm, '');
            
            // Normaliza espaços e quebras de linha
            fixed = fixed.replace(/\s+/g, ' ').trim();
            
            // Garante que comece e termine com chaves se parecer um objeto
            if (!fixed.startsWith('{') && !fixed.startsWith('[') && fixed.includes(':')) {
                fixed = '{' + fixed + '}';
            }
            
            // Corrige aspas simples para duplas
            fixed = fixed.replace(/'/g, '"');
            
            // Corrige aspas malformadas (como "rua \"Rua das Flores")
            fixed = fixed.replace(/"([^"]*)\\"([^"]*)"([^"]*)"([^"]*)/g, '"$1$2$3$4"');
            
            // Adiciona aspas em chaves sem aspas
            fixed = fixed.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g, '$1"$2":');
            
            // Adiciona aspas em valores que parecem strings mas não têm aspas
            fixed = fixed.replace(/:(\s*)([a-zA-Z][a-zA-Z0-9\s]*[a-zA-Z0-9])(\s*[,}])/g, ':"$2"$3');
            
            // Corrige números com espaços
            fixed = fixed.replace(/:\s*(\d+)\s*([,}])/g, ':$1$2');
            
            // Remove vírgulas extras
            fixed = fixed.replace(/,(\s*[}\]])/g, '$1');
            
            // Adiciona vírgulas ausentes entre propriedades
            fixed = fixed.replace(/([}\]"])\s*(["{])/g, '$1,$2');
            fixed = fixed.replace(/([0-9])\s*(["{])/g, '$1,$2');
            fixed = fixed.replace(/(true|false|null)\s*(["{])/g, '$1,$2');
            
            // Corrige undefined para null
            fixed = fixed.replace(/\bundefined\b/g, 'null');
            
            console.log('Resultado da correção básica:', fixed);
            return fixed;
        }

        function extractStructuredData(input) {
            console.log('🔍 Extraindo dados estruturados...');
            
            const data = {};
            let workingText = input;
            
            // Remove chaves externas se existirem
            workingText = workingText.replace(/^\s*\{\s*/, '').replace(/\s*\}\s*$/, '');
            
            // Divide por vírgulas, mas cuidado com vírgulas dentro de strings
            const pairs = smartSplit(workingText, ',');
            
            pairs.forEach(pair => {
                if (pair.includes(':')) {
                    const colonIndex = pair.indexOf(':');
                    const key = pair.substring(0, colonIndex).trim().replace(/^["']|["']$/g, '');
                    const value = pair.substring(colonIndex + 1).trim();
                    
                    if (key.length > 0 && !data[key]) {
                        data[key] = processValue(value);
                    }
                }
            });
            
            console.log('Dados extraídos:', data);
            return data;
        }

        function smartSplit(text, delimiter) {
            const result = [];
            let current = '';
            let inQuotes = false;
            let quoteChar = '';
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                
                if ((char === '"' || char === "'") && text[i-1] !== '\\') {
                    if (!inQuotes) {
                        inQuotes = true;
                        quoteChar = char;
                    } else if (char === quoteChar) {
                        inQuotes = false;
                        quoteChar = '';
                    }
                }
                
                if (char === delimiter && !inQuotes) {
                    if (current.trim().length > 0) {
                        result.push(current.trim());
                    }
                    current = '';
                } else {
                    current += char;
                }
            }
            
            if (current.trim().length > 0) {
                result.push(current.trim());
            }
            
            return result;
        }

        function processValue(value) {
            if (!value || value.length === 0) return '';
            
            value = value.trim();
            
            // Remove vírgulas no final
            value = value.replace(/,\s*$/, '');
            
            // Boolean
            if (value === 'true') return true;
            if (value === 'false') return false;
            
            // Null
            if (value === 'null' || value === 'undefined') return null;
            
            // Number (inteiro)
            if (/^-?\d+$/.test(value)) {
                return parseInt(value);
            }
            
            // Number (decimal)
            if (/^-?\d+\.\d+$/.test(value)) {
                return parseFloat(value);
            }
            
            // Remove aspas se for string
            value = value.replace(/^["']|["']$/g, '');
            
            // String vazia
            if (value.length === 0) return '';
            
            return value;
        }

        function extractSimpleKeyValue(input) {
            console.log('🔍 Extraindo pares chave-valor simples...');
            
            const data = {};
            
            // Estratégia mais agressiva para extrair pares
            const patterns = [
                /([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:\s*([^,\n\r]+)/g,
                /([a-zA-Z_$][a-zA-Z0-9_$]*)\s+([^\s,\n\r]+)/g,
                /([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*([^,\n\r]+)/g
            ];
            
            patterns.forEach(pattern => {
                let match;
                const regex = new RegExp(pattern.source, pattern.flags);
                while ((match = regex.exec(input)) !== null) {
                    const key = match[1].trim();
                    let value = match[2].trim();
                    
                    // Remove pontuação no final
                    value = value.replace(/[,;]\s*$/, '');
                    
                    if (key.length > 0 && !data[key]) {
                        data[key] = processValue(value);
                    }
                }
            });
            
            console.log('Pares extraídos:', data);
            return data;
        }

        // Funções de teste
        function testFormatting() {
            const input = document.getElementById('input').textContent;
            const output = document.getElementById('output');
            const status = document.getElementById('status');
            
            console.log('🧪 Testando formatação...');
            
            try {
                const result = processAllScenarios(input);
                
                if (result.success) {
                    output.textContent = result.formatted;
                    status.innerHTML = '✅ Formatação bem-sucedida!';
                    status.className = 'status success';
                    
                    if (result.wasCorrected) {
                        status.innerHTML += ' (JSON foi corrigido automaticamente)';
                    }
                } else {
                    output.textContent = 'Erro: Não foi possível formatar o JSON';
                    status.innerHTML = '❌ Falha na formatação';
                    status.className = 'status error';
                }
            } catch (error) {
                console.error('Erro:', error);
                output.textContent = 'Erro: ' + error.message;
                status.innerHTML = '❌ Erro durante o processamento';
                status.className = 'status error';
            }
        }

        function testCorrection() {
            const input = document.getElementById('input').textContent;
            const output = document.getElementById('output');
            const status = document.getElementById('status');
            
            console.log('🔧 Testando correção...');
            
            try {
                const corrected = basicJSONFix(input);
                output.textContent = corrected;
                status.innerHTML = '🔧 JSON corrigido (pode precisar de formatação adicional)';
                status.className = 'status success';
            } catch (error) {
                console.error('Erro:', error);
                output.textContent = 'Erro: ' + error.message;
                status.innerHTML = '❌ Erro durante a correção';
                status.className = 'status error';
            }
        }

        function clearAll() {
            document.getElementById('output').textContent = '';
            document.getElementById('status').innerHTML = '';
        }

        function loadExample(num) {
            const examples = [
                '{"idade":30,"email":"maria@example.com","ativo":true,"interesses":"leitura","endereco":"rua \\"Rua das Flores","numero":"200","cidade":"Belo Horizonte","estado":"MG","cep":"30123-456"}',
                '{nome: "João", idade: 25, cidade: "São Paulo", ativo: true,}',
                '{usuario: {nome: "Pedro", perfil: {tipo: "admin", permissoes: ["ler", "escrever"]}}, configuracoes: {tema: "escuro"}}',
                '{lista: [item1, "item2", item3,], numeros: [1, 2, 3,], booleans: [true, false,]}'
            ];
            
            document.getElementById('input').textContent = examples[num - 1];
            clearAll();
        }
    </script>
</body>
</html> 